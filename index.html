<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>分红利润与年化收益计算器</title>
  <meta name="theme-color" content="#0ea5e9">
  <link rel="manifest" href="./manifest.webmanifest">
  <link rel="apple-touch-icon" href="./icon-192.png">
  <style>
    :root {
      --bg:#0b1220; --card:#0f172a; --muted:#94a3b8; --text:#e2e8f0; --accent:#0ea5e9;
      --ok:#10b981; --warn:#f59e0b; --danger:#ef4444; --soft:#1e293b;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,#0b1220,#0b1220 30%,#0c1626 100%);color:var(--text);font:16px/1.6 -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,Apple Color Emoji,Segoe UI Emoji}
    .wrap{max-width:680px;margin:0 auto;padding:24px 16px 32px}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
    h1{font-size:20px;margin:0;font-weight:700}
    .card{background:rgba(15,23,42,.8);backdrop-filter: blur(6px);border:1px solid #1f2a44;border-radius:16px;box-shadow:0 10px 28px rgba(2,6,23,.3);padding:16px}
    .grid{display:grid;gap:12px}
    @media (min-width:520px){ .grid.cols-2{grid-template-columns:1fr 1fr} .grid.cols-4{grid-template-columns:repeat(4,1fr)} }
    label{display:block;font-size:12px;color:var(--muted);margin:2px 0 6px}
    input[type="number"]{width:100%;padding:12px 14px;border:1px solid #32405f;background:#0b1220;color:var(--text);border-radius:12px;outline:none;-webkit-appearance:none}
    input[type="number"]:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(14,165,233,.25)}
    .stat{background:var(--soft);border:1px solid #25324d;border-radius:12px;padding:12px 12px}
    .k{font-size:12px;color:var(--muted)}
    .v{font-size:20px;font-weight:700;margin-top:2px;word-break:break-all}
    .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    button{border:0;border-radius:12px;padding:10px 14px;cursor:pointer;font-weight:600}
    .ghost{background:#27324b;color:#dbeafe}
    .primary{background:var(--accent);color:#002438}
    .secondary{background:#1f2937;color:#d1d5db;border:1px solid #334155}
    .note{color:var(--muted);font-size:12px;margin-top:12px}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:#0b1220;border:1px solid #26334f;font-size:12px;color:#a5b4fc}
    .footer{margin-top:18px;display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
    .badge{font-size:12px;color:#a1a1aa}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>分红利润与年化收益计算器</h1>
      <span class="pill">移动端优化 · 可离线</span>
    </header>

    <div class="card">
      <div class="grid cols-2">
        <div>
          <label>当前 A 股盈利（元）</label>
          <input id="a" type="number" inputmode="decimal" step="0.01" placeholder="例如 500000">
        </div>
        <div>
          <label>当前 H 股盈利（元）</label>
          <input id="h" type="number" inputmode="decimal" step="0.01" placeholder="例如 240000">
        </div>
      </div>

      <div class="grid cols-4" style="margin-top:12px">
        <div class="stat">
          <div class="k">港币换算系数</div>
          <div class="v"><span class="mono">1 人民币 = <span id="fx">0.91633</span> 港币</span></div>
        </div>
        <div class="stat">
          <div class="k">分红比例</div>
          <div class="v"><span id="rate">40</span>%</div>
        </div>
        <div class="stat">
          <div class="k">分红利润</div>
          <div class="v" id="dividend">¥0.00</div>
        </div>
        <div class="stat">
          <div class="k">折合年化（按投入 10 万）</div>
          <div class="v"><span id="annual">0.00</span>%</div>
        </div>
      </div>

      <div class="row">
        <button class="secondary" id="edit">修改参数</button>
        <button class="ghost" id="clear">清空</button>
        <button class="primary" id="fill">填充示例</button>
      </div>

      <div class="note">
        公式：<span class="mono">分红利润 = (A股盈利 − 35029.41 + H股盈利 × 比例系数 ÷ 3) × 40%</span><br>
        折合年化：<span class="mono">年化% = 分红利润 ÷ 100000 × 100%</span>
      </div>

      <div class="note" id="warn"></div>

      <div class="footer">
        <span class="badge">保存输入到本机 · 离线可用</span>
        <button class="secondary" id="install" style="display:none">安装到主屏幕</button>
      </div>
    </div>
  </div>

  <dialog id="dlg" style="border:none;border-radius:16px;max-width:480px;width:calc(100% - 32px);padding:0;background:#0f172a;color:#e2e8f0">
    <form method="dialog" style="padding:16px 16px 6px">
      <h3 style="margin:0 0 10px;font-size:18px">参数设置</h3>
      <div class="grid cols-2">
        <div>
          <label>比例系数（1 人民币 = ? 港币）</label>
          <input id="fxInput" type="number" inputmode="decimal" step="0.00001" placeholder="0.91633">
        </div>
        <div>
          <label>分红比例（%）</label>
          <input id="rateInput" type="number" inputmode="decimal" step="0.01" placeholder="40">
        </div>
      </div>
      <div class="row" style="margin-top:14px">
        <button value="cancel" class="ghost">取消</button>
        <button id="saveCfg" value="ok" class="primary">保存</button>
      </div>
    </form>
  </dialog>

  <script>
    // Defaults
    const defaults = { fx: 0.91633, rate: 0.40, investBase: 100000 };
    // DOM helpers
    const $ = (id) => document.getElementById(id);
    const toNumber = (v) => { const n = parseFloat(String(v || '').replace(/,/g, '')); return Number.isFinite(n) ? n : 0; };
    const fmtCNY = (n) => n.toLocaleString('zh-CN', { style:'currency', currency:'CNY', maximumFractionDigits: 2 });
    const fmtPct = (n) => n.toLocaleString('zh-CN', { maximumFractionDigits: 2 });

    // State
    let state = {
      a: 0,
      h: 0,
      fx: defaults.fx,
      rate: defaults.rate,
    };

    // Load from localStorage
    try {
      const saved = JSON.parse(localStorage.getItem('ah-calc') || '{}');
      state = { ...state, ...saved };
      $('a').value = saved.a ?? '';
      $('h').value = saved.h ?? '';
    } catch (e) {}

    // Populate UI
    $('fx').textContent = state.fx.toFixed(5);
    $('rate').textContent = (state.rate * 100).toLocaleString('zh-CN', { maximumFractionDigits: 2 });

    function persist(){
      localStorage.setItem('ah-calc', JSON.stringify({ a:$('a').value, h:$('h').value, fx:state.fx, rate:state.rate }));
    }

    function recalc(){
      const a = toNumber($('a').value);
      const h = toNumber($('h').value);
      state.a = a; state.h = h; persist();

      const dividend = (a - 35029.41 + (h * state.fx) / 3) * state.rate;
      const annual = (dividend / defaults.investBase) * 100;

      $('dividend').textContent = fmtCNY(dividend);
      $('annual').textContent = fmtPct(annual);

      const warn = $('warn');
      if (dividend < 0) {
        warn.innerHTML = '提示：当前结果为负值，可能表示可分配利润不足。请检查输入或口径。';
        warn.style.color = '#fca5a5';
      } else {
        warn.innerHTML = '提示：长按上方地址栏可添加到主屏幕。参数已保存到本机。';
        warn.style.color = '#94a3b8';
      }
    }

    $('a').addEventListener('input', recalc);
    $('h').addEventListener('input', recalc);
    $('clear').addEventListener('click', () => { $('a').value=''; $('h').value=''; recalc(); });
    $('fill').addEventListener('click', () => { $('a').value='500000'; $('h').value='240000'; recalc(); });

    // Settings dialog
    const dlg = $('dlg'); const fxInput = $('fxInput'); const rateInput = $('rateInput');
    $('edit').addEventListener('click', () => {
      fxInput.value = state.fx.toFixed(5);
      rateInput.value = (state.rate * 100).toFixed(2);
      dlg.showModal();
    });
    $('saveCfg').addEventListener('click', (e) => {
      e.preventDefault();
      const newFx = toNumber(fxInput.value);
      const newRatePct = toNumber(rateInput.value);
      if (newFx > 0) { state.fx = newFx; $('fx').textContent = state.fx.toFixed(5); }
      if (newRatePct > 0) { state.rate = newRatePct / 100; $('rate').textContent = (state.rate*100).toFixed(2); }
      persist();
      dlg.close('ok'); recalc();
    });

    // PWA install prompt
    let deferredPrompt = null;
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      $('install').style.display = 'inline-block';
    });
    $('install').addEventListener('click', async () => {
      if (!deferredPrompt) return;
      deferredPrompt.prompt();
      await deferredPrompt.userChoice;
      deferredPrompt = null;
      $('install').style.display = 'none';
    });

    // Register service worker (for offline)
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js').catch(()=>{});
      });
    }

    recalc();
  </script>
</body>
</html>
